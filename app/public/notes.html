<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notes - Test Builder</title>
    <link rel="stylesheet" href="/public/styles.css" />
    <style>
      .toc a { text-decoration: none; color: #111827; }
      .toc a:hover { text-decoration: underline; }
      .note { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
      /* Markdown styles */
      .md h1 { font-size: 24px; margin: 18px 0 8px; }
      .md h2 { font-size: 20px; margin: 16px 0 8px; }
      .md h3 { font-size: 18px; margin: 14px 0 6px; }
      .md p { margin: 8px 0; line-height: 1.5; }
      .md ul, .md ol { margin: 8px 0 8px 22px; }
      .md code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .md pre { background: #0b1021; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow: auto; }
      .md pre code { background: transparent; padding: 0; }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <h1 style="margin:0">Notes</h1>
        <nav>
          <a class="btn" href="/">‚Üê Back</a>
        </nav>
      </header>
      <main class="main">
        <section id="toc" class="panel fade"></section>
        <section id="content" class="panel fade hidden"></section>
      </main>
    </div>
    <script type="module">
      const tocEl = document.getElementById('toc');
      const contentEl = document.getElementById('content');
      async function loadIndex() {
        const res = await fetch('/data/notes_index.json');
        if (!res.ok) {
          tocEl.innerHTML = '<div class="muted">No notes yet. Create files under <code>notes/</code> and run <code>node app/tools/notes_scan.js</code>.</div>';
          return null;
        }
        return await res.json();
      }
      function renderTOC(idx) {
        const cats = Object.keys(idx.notes);
        tocEl.innerHTML = `
          <h2 style="margin-top:0">Table of Contents</h2>
          ${cats.map(cat => {
            const subs = Object.keys(idx.notes[cat] || {});
            return `<div style="margin-bottom:10px">
              <div style="font-weight:700">${cat}</div>
              <div style="margin-left:10px">
                ${subs.map(sub => {
                  const files = idx.notes[cat][sub] || [];
                  return `<div style="margin:6px 0">
                    <div style="font-weight:600">${sub}</div>
                    <ul class="toc" style="margin:6px 0 0 18px; padding:0; list-style: disc;">
                      ${files.map(f => `<li><a href="#" data-path="${f.path}">${f.title}</a></li>`).join('')}
                    </ul>
                  </div>`;
                }).join('')}
              </div>
            </div>`;
          }).join('')}
        `;
        tocEl.querySelectorAll('a[data-path]').forEach(a => {
          a.addEventListener('click', async (e) => {
            e.preventDefault();
            const p = a.getAttribute('data-path');
            await showNote(p);
          });
        });
      }
      async function showNote(p) {
        const res = await fetch(p);
        const text = await res.text();
        contentEl.classList.remove('hidden');
        const html = markdownToHtml(text);
        const headingsToc = buildHeadingsToc(html);
        contentEl.innerHTML = `
          <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
            <aside style="flex:1 1 220px; max-width:260px;">
              <div class="panel" style="margin:0">
                <div style="font-weight:700; margin-bottom:6px">On this page</div>
                <div class="toc">${headingsToc}</div>
              </div>
            </aside>
            <article style="flex:3 1 520px">
              <div class="note md">${html}</div>
            </article>
          </div>`;
      }
      function markdownToHtml(md) {
        function esc(s){return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));}
        // code fences
        md = md.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${esc(code)}</code></pre>`);
        // headings
        md = md.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>')
               .replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>')
               .replace(/^####\s+(.*)$/gm, '<h4>$1</h4>')
               .replace(/^###\s+(.*)$/gm, '<h3 id="$1">$1</h3>')
               .replace(/^##\s+(.*)$/gm, '<h2 id="$1">$1</h2>')
               .replace(/^#\s+(.*)$/gm, '<h1 id="$1">$1</h1>');
        // bulleted lists '- '
        md = md.replace(/^(?:-\s.*(?:\n|$))+?/gm, m => {
          const items = m.trim().split(/\n/).map(l => l.replace(/^-\s+/, ''));
          return `<ul>${items.map(i => `<li>${inline(i)}</li>`).join('')}</ul>`;
        });
        function inline(s){
          return s.replace(/`([^`]+)`/g, (_, a) => `<code>${esc(a)}</code>`)
                  .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*([^*]+)\*/g, '<em>$1</em>');
        }
        const blocks = md.split(/\n\n+/).map(block => {
          if (/^\s*<(h\d|ul|pre)/i.test(block)) return block;
          return `<p>${inline(block.replace(/\n/g, ' '))}</p>`;
        });
        return blocks.join('\n');
      }
      function buildHeadingsToc(html){
        const div = document.createElement('div');
        div.innerHTML = html;
        const hs = div.querySelectorAll('h1, h2, h3');
        hs.forEach(h => { if (!h.id) h.id = h.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g,'-'); });
        return Array.from(hs).map(h => `<div style="margin-left:${(parseInt(h.tagName[1])-1)*8}px"><a href="#${h.id}">${escapeHtml(h.textContent)}</a></div>`).join('');
      }
      function escapeHtml(s){return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));}
      (async function(){
        const idx = await loadIndex();
        if (idx) renderTOC(idx);
      })();
    </script>
  </body>
  </html>



<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notes - Test Builder</title>
    <link rel="stylesheet" href="/public/styles.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
      .toc a { text-decoration: none; color: #111827; }
      .toc a:hover { text-decoration: underline; }
      .note { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
      /* Markdown styles */
      .md h1 { font-size: 24px; margin: 18px 0 8px; }
      .md h2 { font-size: 20px; margin: 16px 0 8px; }
      .md h3 { font-size: 18px; margin: 14px 0 6px; }
      .md p { margin: 8px 0; line-height: 1.5; }
      .md ul, .md ol { margin: 8px 0 8px 22px; }
      #content { max-width: 100%; overflow-x: visible; box-sizing: border-box; }
      .md { max-width: 100%; word-wrap: break-word; overflow-wrap: break-word; box-sizing: border-box; }
      .md code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 14px; word-break: break-word; max-width: 100%; overflow-wrap: break-word; }
      .md pre { background: #2d2d2d; color: #cccccc; padding: 12px; border-radius: 8px; overflow-x: auto; overflow-y: hidden; max-width: 100%; box-sizing: border-box; display: block; width: 100%; font-size: 14px; }
      .md pre code { background: transparent; padding: 0; white-space: pre; word-wrap: normal; overflow-wrap: normal; display: block; font-size: 14px; color: inherit; }
      /* ASCII art diagrams - must NOT wrap to preserve alignment, but smaller font and smooth scroll */
      .md pre.language-text { 
        overflow-x: auto;
        overflow-y: visible;
        width: 100%;
        white-space: pre !important; /* Must preserve exact spacing */
        font-size: 12px !important; /* Smaller font so more fits */
      }
      .md pre code[class*="language-text"] { 
        /* ASCII art must NOT wrap - preserve exact character positions */
        white-space: pre !important; 
        word-wrap: normal !important;
        overflow-wrap: normal !important;
        word-break: normal !important;
        display: block;
        width: max-content; /* Allow content to be wider than container */
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
        line-height: 1.2;
        font-size: 12px !important;
      }
      /* Override Prism colors if needed */
      .md pre[class*="language-"] { margin: 16px 0; }
      .md table { width: 100%; max-width: 100%; border-collapse: collapse; margin: 16px 0; table-layout: fixed; box-sizing: border-box; }
      .md table td, .md table th { padding: 8px; border: 1px solid #e5e7eb; word-break: break-word; overflow-wrap: break-word; }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <div class="nav-bar">
          <div class="nav-left">
            <a href="/public/index.html" class="brand" title="Home">
              <span class="logo-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 7l9-4 9 4-9 4-9-4z" fill="currentColor" style="color: var(--accent);"/>
                  <path d="M5 10v6c0 .6.4 1 1 1l6 3 6-3c.6 0 1-.4 1-1v-6" stroke="#4B5563" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="brand-text"><span class="accent">Study</span> Buddy</span>
            </a>
          </div>
          <nav class="nav-center">
            <a id="nav-home" class="btn" href="/public/index.html">Home</a>
            <a id="nav-notes" class="btn" href="/public/notes.html">Notes</a>
            <a id="nav-flash" class="btn" href="/public/flashcards.html">Flashcards</a>
            <a id="nav-tests" class="btn" href="/public/index.html#tests">Tests</a>
          </nav>
          <div class="nav-right">
            <a class="btn primary" href="/public/import.html" title="Paste JSON to add questions">+ Import JSON</a>
          </div>
        </div>
      </header>
      <main class="main">
        <section id="notes-landing" class="panel fade hidden"></section>
        <section id="toc" class="panel fade hidden"></section>
        <section id="content" class="panel fade hidden"></section>
      </main>
    </div>
    <script>
      (function setActive(){
        const el = document.getElementById('nav-notes');
        if (el) el.classList.add('active');
      })();
    </script>
    <script type="module">
      const landingEl = document.getElementById('notes-landing');
      const tocEl = document.getElementById('toc');
      const contentEl = document.getElementById('content');
      function getQuery() {
        const p = new URLSearchParams(location.search);
        const cat = p.get('cat');
        const sub = p.get('sub');
        return { cat, sub };
      }
      async function loadIndex() {
        const res = await fetch('/data/notes_index.json');
        if (!res.ok) {
          tocEl.innerHTML = '<div class="muted">No notes yet. Create files under <code>notes/</code> and run <code>node app/tools/notes_scan.js</code>.</div>';
          return null;
        }
        return await res.json();
      }
      function renderTOC(idx, filterCat, filterSub) {
        const cats = filterCat ? [filterCat] : Object.keys(idx.notes);
        const title = filterCat ? `${filterCat}${filterSub ? ' / ' + filterSub : ''}` : 'Table of Contents';
        tocEl.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <h2 style="margin:0">${title}</h2>
            ${filterCat ? `<a class="btn" href="/public/notes.html">‚Üê All Subjects</a>` : ''}
          </div>
          ${cats.map(cat => {
            const subsAll = Object.keys(idx.notes[cat] || {});
            const subs = filterSub ? subsAll.filter(s => s === filterSub) : subsAll;
            return `<div style="margin-bottom:10px">
              ${filterCat ? '' : `<div style=\"font-weight:700\">${cat}</div>`}
              <div style="margin-left:${filterCat ? '0' : '10px'}">
                ${subs.map(sub => {
                  const files = idx.notes[cat][sub] || [];
                  return `<div style="margin:6px 0">
                    <div style="font-weight:600">${sub}</div>
                    <ul class="toc" style="margin:6px 0 0 18px; padding:0; list-style: disc;">
                      ${files.map(f => `<li><a href="#" data-path="${f.path}">${f.title}</a></li>`).join('')}
                    </ul>
                  </div>`;
                }).join('')}
              </div>
            </div>`;
          }).join('')}
        `;
        tocEl.querySelectorAll('a[data-path]').forEach(a => {
          a.addEventListener('click', async (e) => {
            e.preventDefault();
            const p = a.getAttribute('data-path');
            await showNote(p);
          });
        });
      }

      function renderLanding(idx) {
        const notes = idx.notes || {};
        const cats = Object.keys(notes);
        landingEl.classList.remove('hidden');
        tocEl.classList.add('hidden');
        contentEl.classList.add('hidden');
        landingEl.innerHTML = `
          <h2 style="margin-top:0">Subjects</h2>
          <div class="grid">
            ${cats.map(cat => {
              const subs = Object.keys(notes[cat] || {});
              const count = subs.reduce((a,s)=> a + (notes[cat][s]?.length||0), 0);
              return `<div class="card">
                <div style="font-weight:600; text-transform:capitalize;">${cat}</div>
                <div class="muted" style="margin:4px 0 8px 0;">${count} note(s)</div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  ${subs.map(sub => `<a class=\"btn\" href=\"/public/notes.html?cat=${encodeURIComponent(cat)}&sub=${encodeURIComponent(sub)}\">${sub}</a>`).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
        `;
      }
      async function showNote(p) {
        const res = await fetch(p);
        const text = await res.text();
        contentEl.classList.remove('hidden');
        const html = markdownToHtml(text);
        const headingsToc = buildHeadingsToc(html);
        contentEl.innerHTML = `
          <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; max-width:1200px; margin:0 auto; box-sizing:border-box; overflow:hidden; width:100%;">
            <aside style="flex:1 1 220px; max-width:260px; min-width:220px;">
              <div class="panel" style="margin:0">
                <div style="font-weight:700; margin-bottom:6px">On this page</div>
                <div class="toc">${headingsToc}</div>
              </div>
            </aside>
            <article style="flex:3 1 520px; min-width:0; max-width:900px; box-sizing:border-box;">
              <div class="note md" style="width:100%; max-width:100%; box-sizing:border-box;">${html}</div>
            </article>
          </div>`;
        // Apply syntax highlighting with Prism (skip text/ASCII art blocks)
        if (window.Prism) {
          contentEl.querySelectorAll('pre code[class*="language-"]').forEach(block => {
            // Don't highlight text/ASCII art blocks - they need exact formatting preserved
            if (!block.classList.contains('language-text')) {
              window.Prism.highlightElement(block);
            }
          });
        }
      }
      function markdownToHtml(md) {
        function esc(s){return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));}
        // code fences with language support
        md = md.replace(/```(\w+)?\s*\n([\s\S]*?)```/g, (_, lang, code) => {
          // For text/ASCII art, preserve all whitespace including leading/trailing newlines
          let processed = lang === 'text' ? code : code.trim();
          // Ensure newlines are preserved (already are, but be explicit)
          processed = processed.replace(/\r\n/g, '\n'); // Normalize line endings
          if (lang) {
            const langClass = ` class="language-${lang}"`;
            return `<pre${langClass}><code${langClass}>${esc(processed)}</code></pre>`;
          }
          return `<pre><code>${esc(processed)}</code></pre>`;
        });
        // headings
        md = md.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>')
               .replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>')
               .replace(/^####\s+(.*)$/gm, '<h4>$1</h4>')
               .replace(/^###\s+(.*)$/gm, '<h3 id="$1">$1</h3>')
               .replace(/^##\s+(.*)$/gm, '<h2 id="$1">$1</h2>')
               .replace(/^#\s+(.*)$/gm, '<h1 id="$1">$1</h1>');
        // bulleted lists '- '
        md = md.replace(/^(?:-\s.*(?:\n|$))+?/gm, m => {
          const items = m.trim().split(/\n/).map(l => l.replace(/^-\s+/, ''));
          return `<ul>${items.map(i => `<li>${inline(i)}</li>`).join('')}</ul>`;
        });
        function inline(s){
          return s.replace(/`([^`]+)`/g, (_, a) => `<code>${esc(a)}</code>`)
                  .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*([^*]+)\*/g, '<em>$1</em>');
        }
        const blocks = md.split(/\n\n+/).map(block => {
          if (/^\s*<(h\d|ul|pre)/i.test(block)) return block;
          return `<p>${inline(block.replace(/\n/g, ' '))}</p>`;
        });
        return blocks.join('\n');
      }
      function buildHeadingsToc(html){
        const div = document.createElement('div');
        div.innerHTML = html;
        const hs = div.querySelectorAll('h1, h2, h3');
        hs.forEach(h => { if (!h.id) h.id = h.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g,'-'); });
        return Array.from(hs).map(h => `<div style="margin-left:${(parseInt(h.tagName[1])-1)*8}px"><a href="#${h.id}">${escapeHtml(h.textContent)}</a></div>`).join('');
      }
      function escapeHtml(s){return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));}
      // Load Prism.js for syntax highlighting
      const prismScript = document.createElement('script');
      prismScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js';
      prismScript.onload = () => {
        // Load common languages
        const langs = ['yaml', 'json', 'bash', 'javascript', 'python', 'go', 'dockerfile', 'markdown'];
        langs.forEach(lang => {
          const script = document.createElement('script');
          script.src = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-${lang}.min.js`;
          document.head.appendChild(script);
        });
      };
      prismScript.onerror = () => {
        console.warn('Prism.js failed to load, syntax highlighting disabled');
      };
      document.head.appendChild(prismScript);
      // Initialize app (don't wait for Prism)
      (async function(){
        const idx = await loadIndex();
        if (!idx) return;
        const { cat, sub } = getQuery();
        if (cat || sub) {
          landingEl.classList.add('hidden');
          tocEl.classList.remove('hidden');
          renderTOC(idx, cat || null, sub || null);
        } else {
          renderLanding(idx);
        }
      })();
    </script>
  </body>
  </html>


